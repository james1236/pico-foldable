from buzzer_music import music
import utime
import _thread

musicPlaying = False
mySong = None

def musicThread():
    global mySong
    global musicPlaying
    
    while True:
        utime.sleep(0.04)
        if (not musicPlaying):
            mySong.stop()
            del mySong
            break
        
        try:
            mySong.tick()
        except Exception:
            pass

#Optional metadata for main menu
class description:
    name = "Demo"
    #32x32 Horizonal - 1 bit per pixel (https://javl.github.io/image2cpp/)
    thumbnail = bytearray(b"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x18\xd8\x60\x09\x21\x24\x90\x09\x21\x24\x90\x09\x39\x24\x90\x09\x21\x04\x90\x09\x21\x04\x90\x09\x21\x04\x90\x0e\x19\x04\x60\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xc0\x00\x00\x13\xc8\x00\x00\x3e\x7e\x00\x00\xfe\x7f\x00\x00\x61\x86\x00\x00\x77\xee\x00\x01\xee\x77\x80\x01\xcc\x33\x80\x01\xcc\x33\x80\x01\xee\x77\x80\x00\x77\xee\x00\x00\x61\x86\x00\x00\xfe\x7f\x00\x00\x7e\x7e\x00\x00\x13\xc8\x00\x00\x03\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00")

#Required class named 'creation'
class creation:
    def __init__(self, display, controller, *args): #Required init method in creation class
        global mySong
        global musicPlaying
        self.frame = 0
        self.display = display
        self.controller = controller
        
        #Init music
        # song = '2 A4 1 32;0 G4 1 32;2 D4 1 32;4 G4 1 32;8 F#4 1 32;10 C#4 1 32;12 A3 1 32;14 E4 1 32;18 F#4 1 32;22 D4 1 32;24 E4 1 32;26 D4 1 32;9 E4 1 32;8 D4 1 32;10 F#3 1 32;7 B3 1 32;16 G3 1 32;18 D4 1 32;20 G3 1 32;22 A3 1 32;24 E3 1 32;28 F#3 1 32;23 F#3 1 32;28 F#4 1 32;30 A4 1 32;30 A3 1 32;26 B3 1 32;30 D4 1 32;34 A4 1 32;32 G4 1 32;34 D4 1 32;36 G4 1 32;40 F#4 1 32;42 C#4 1 32;44 A3 1 32;46 E4 1 32;50 F#4 1 32;54 D4 1 32;56 E4 1 32;58 D4 1 32;41 E4 1 32;40 D4 1 32;42 F#3 1 32;39 B3 1 32;48 G3 1 32;50 D4 1 32;52 G3 1 32;54 A3 1 32;56 E3 1 32;60 F#3 1 32;55 F#3 1 32;60 F#4 1 32;62 A4 1 32;62 A3 1 32;58 B3 1 32;62 D4 1 32;79 A#7 1 7;122 C#7 1 7;80 F#7 1 7 32;64 D5 1 32;65 B4 1 32;70 B4 1 32;80 B4 1 32;84 B4 1 32;80 G5 1 32;64 D6 1 32;72 C#6 1 32;64 F#5 1 32;72 F#5 1 32;88 E5 1 32;89 G5 1 32;90 B5 1 32;91 C#6 1 32;94 C#6 1 32;92 F#6 1 32;96 D5 1 32;97 B4 1 32;102 B4 1 32;112 B4 1 32;116 B4 1 32;112 G5 1 32;96 D6 1 32;104 C#6 1 32;96 F#5 1 32;104 F#5 1 32;120 E5 1 32;121 G5 1 32;122 B5 1 32;123 C#6 1 32;126 C#6 1 32;124 F#6 1 32;98 F#6 1 32;100 E6 1 32;106 A5 1 32;108 C#6 1 32;110 F#5 1 32;102 D6 1 32;114 E6 1 32;116 F#6 1 32;118 B6 1 32;120 G6 1 32;123 A6 1 32;126 B6 1 32;83 A6 1 32;113 B6 1 32;90 B6 1 32;66 A4 1 32;64 G4 1 32;66 D4 1 32;68 G4 1 32;72 F#4 1 32;74 C#4 1 32;76 A3 1 32;78 E4 1 32;82 F#4 1 32;86 D4 1 32;88 E4 1 32;90 D4 1 32;73 E4 1 32;72 D4 1 32;74 F#3 1 32;71 B3 1 32;80 G3 1 32;82 D4 1 32;84 G3 1 32;86 A3 1 32;88 E3 1 32;92 F#3 1 32;87 F#3 1 32;92 F#4 1 32;94 A4 1 32;94 A3 1 32;90 B3 1 32;94 D4 1 32;98 A4 1 32;96 G4 1 32;98 D4 1 32;100 G4 1 32;104 F#4 1 32;106 C#4 1 32;108 A3 1 32;110 E4 1 32;114 F#4 1 32;118 D4 1 32;120 E4 1 32;122 D4 1 32;105 E4 1 32;104 D4 1 32;106 F#3 1 32;103 B3 1 32;112 G3 1 32;114 D4 1 32;116 G3 1 32;118 A3 1 32;120 E3 1 32;124 F#3 1 32;119 F#3 1 32;124 F#4 1 32;126 A4 1 32;126 A3 1 32;122 B3 1 32;126 D4 1 32'
        # song = '0 B3 1 41;0 E4 1 41;2 A4 1 41;3 B4 1 41;4 G4 1 41;5 E4 1 41;6 A3 1 41;6 C#4 1 41;12 B3 1 41;14 E4 1 41;15 B4 1 41;16 F#4 1 41;17 B4 1 41;18 E5 1 41;18 E4 1 41;18 G3 1 41;21 F#5 1 41;21 A4 1 41;21 B3 1 41;0 E3 1 41;24 B3 1 41;24 E4 1 41;26 A4 1 41;27 B4 1 41;29 E5 1 41;29 E4 1 41;30 B3 1 41;30 B4 1 41;37 B3 1 41;38 E4 1 41;39 B4 1 41;40 F#4 1 41;41 B4 1 41;42 E5 1 41;42 E4 1 41;42 G3 1 41;45 F#5 1 41;45 A4 1 41;45 B3 1 41;24 E3 1 41;13 B3 1 41;28 C#5 1 41;30 G5 1 41;31 F#5 1 41;33 D5 1 41;33 F#5 1 41;35 A4 1 41;36 E4 1 41;0 B5 1 41;0 F#5 1 41;6 E6 1 41;6 B5 1 41;6 E5 1 41;11 E6 1 41;12 F#6 1 41;14 A6 1 41;15 D6 1 41;16 F#6 1 41;17 E6 1 41;18 B5 1 41;19 C#6 1 41;20 D6 1 41;21 E6 1 41;22 F#6 1 41;23 D6 1 41;24 B5 1 41;24 F#5 1 41;30 E6 1 41;30 A6 1 41;33 B6 1 41;33 F#6 1 41;36 D7 1 41;36 D6 1 41;37 C#7 1 41;38 A6 1 41;39 B6 1 41;40 F#6 1 41;41 D6 1 41;42 E6 1 41;43 A6 1 41;44 C#7 1 41;45 B6 1 41;47 E7 1 41;46 A7 1 41;46 A6 1 41;47 B5 1 41;47 E6 1 41'
        # song = '32 E5 1 43;40 G#5 1 43;40 D5 1 43;40 B4 1 43;40 E5 1 43;42 E5 1 43;42 C#5 1 43;42 A4 1 43;42 F#4 1 43;42 D4 1 43;32 C#5 1 43;32 E4 1 43;32 G#4 1 43;48 G#5 1 43;48 B5 1 43;48 E6 1 43;48 E5 1 43;48 B4 1 43;48 G#4 1 43;48 E4 1 43;54 A6 1 43;52 B6 1 43;56 E6 1 43;56 A5 1 43;56 D6 1 43;57 F#5 1 43;58 C#5 1 43;58 E5 1 43;60 F#5 1 43;61 A5 1 43;62 E6 1 43;63 C#7 1 43;96 E7 1 43;97 B6 1 43;98 F#6 1 43;99 D6 1 43;100 C#6 1 43;100 B6 1 43;101 F#6 1 43;102 D6 1 43;103 C#6 1 43;104 B5 1 43;104 F#6 1 43;105 D6 1 43;106 C#6 1 43;107 F#6 1 43;108 A6 1 43;108 B5 1 43;110 G#6 1 43;110 B5 1 43;112 E6 1 43;114 E7 1 43;116 C#7 1 43;118 E7 1 43;120 B6 1 43;122 E7 1 43;124 A6 1 43;126 B6 1 43;128 C#7 1 43;130 A7 1 43;134 B7 1 43;135 A7 1 43;136 E7 1 43;137 C#7 1 43;138 A6 1 43;139 E6 1 43;140 C#6 1 43;141 D6 1 43;142 F#6 1 43;143 E6 1 43;107 C#6 1 43;96 G#5 1 43;100 G#5 1 43;104 F#5 1 43;107 F#5 1 43;110 C#5 1 43;112 D5 1 43;113 E5 1 43;114 G#5 1 43;115 B5 1 43;116 D5 1 43;117 E5 1 43;118 G#5 1 43;119 C#6 1 43;120 E5 1 43;121 B5 1 43;122 E6 1 43;123 C#6 1 43;124 F#6 1 43;125 E6 1 43;126 C#6 1 43;127 B5 1 43;56 C#4 1 43;56 E4 1 43;56 A4 1 43;96 A4 1 43;96 E5 1 43;96 D4 1 43;100 E5 1 43;100 A4 1 43;100 D4 1 43;104 A4 1 43;104 D4 1 43;107 C#4 1 43;104 D5 1 43;107 C#5 1 43;107 A4 1 43;112 A4 1 43;116 A4 1 43;120 G#4 1 43;124 G#4 1 43;124 E4 1 43;124 B3 1 43;126 B3 1 43;126 E4 1 43;126 G#4 1 43;128 B4 1 43;130 F#5 1 43;128 E5 1 43;132 G#5 1 43;0 E5 1 43;8 G#5 1 43;8 D5 1 43;8 B4 1 43;8 E5 1 43;10 E5 1 43;10 C#5 1 43;10 A4 1 43;10 F#4 1 43;10 D4 1 43;0 C#5 1 43;0 E4 1 43;0 G#4 1 43;16 G#5 1 43;16 B5 1 43;16 E6 1 43;16 E5 1 43;16 B4 1 43;16 G#4 1 43;16 E4 1 43;22 A6 1 43;20 B6 1 43;24 E6 1 43;24 A5 1 43;24 D6 1 43;25 F#5 1 43;26 C#5 1 43;26 E5 1 43;24 C#4 1 43;24 E4 1 43;24 A4 1 43;26 A3 1 43;64 E7 1 43;65 B6 1 43;66 F#6 1 43;67 D6 1 43;68 C#6 1 43;68 B6 1 43;69 F#6 1 43;70 D6 1 43;71 C#6 1 43;72 B5 1 43;72 F#6 1 43;73 D6 1 43;74 C#6 1 43;75 F#6 1 43;76 A6 1 43;76 B5 1 43;78 G#6 1 43;78 B5 1 43;80 E6 1 43;82 E7 1 43;84 C#7 1 43;86 E7 1 43;88 B6 1 43;90 E7 1 43;92 A6 1 43;94 B6 1 43;75 C#6 1 43;64 G#5 1 43;68 G#5 1 43;72 F#5 1 43;75 F#5 1 43;78 C#5 1 43;80 D5 1 43;81 E5 1 43;82 G#5 1 43;83 B5 1 43;84 D5 1 43;85 E5 1 43;86 G#5 1 43;87 C#6 1 43;88 E5 1 43;89 B5 1 43;90 E6 1 43;91 C#6 1 43;92 F#6 1 43;93 E6 1 43;94 C#6 1 43;95 B5 1 43;64 A4 1 43;64 E5 1 43;64 D4 1 43;68 E5 1 43;68 A4 1 43;68 D4 1 43;72 A4 1 43;72 D4 1 43;75 C#4 1 43;72 D5 1 43;75 C#5 1 43;75 A4 1 43;80 A4 1 43;84 A4 1 43;88 G#4 1 43;92 G#4 1 43;92 E4 1 43;92 B3 1 43;94 B3 1 43;94 E4 1 43;94 G#4 1 43'
        song = '0.08209457248449326 A4 1 43 5;0 E5 1 43 5;0 B5 1 43 5;7.922383785247803 E5 1 43 5;8.068573951721191 B4 1 43 5;8.014118194580078 D4 1 43 5;12.019848823547363 D5 1 43 5;14.096240043640137 C5 1 43 5;15.993935585021973 B4 1 43 5;16.045032501220703 G4 1 43 5;16.069293975830078 E4 1 43 5;16.029088973999023 B5 1 43 5;15.936178207397461 D6 1 43 5;14.947376251220703 B3 1 43 5;24.048398971557617 B5 1 43 5;26.015518188476562 D6 1 43 5;26.01312828063965 E4 1 43 5;26.096118927001953 D5 1 43 5;24.020339965820312 D4 1 43 5;31.9774169921875 F#6 1 43 5;40.035587310791016 F#6 1 43 5;40.06464767456055 D6 1 43 5;39.93009567260742 A5 1 43 5;39.92994689941406 B4 1 43 5;46.060665130615234 D#5 1 43 5;54.95461654663086 B4 1 43 5;55.94185256958008 A4 1 43 5;40.03247833251953 A3 1 43 5;48.05028533935547 G4 1 43 5;32.088687896728516 E5 1 43 5;31.92564582824707 B5 1 43 5;32.00453186035156 A4 1 43 5;0 E3 1 43 5;7.904675483703613 D3 1 43 5;15.926554679870605 G3 1 43 5;31.993227005004883 A3 1 43 5;40.037593841552734 A2 1 43 5;48.02098846435547 G3 1 43 5;47.94720458984375 B3 1 43 5;48.02096939086914 B6 1 43 5;64.01144409179688 A4 1 43 5;64.0926742553711 E5 1 43 5;64.03766632080078 B5 1 43 5;67.94483947753906 D6 1 43 5;70.08334350585938 A5 1 43 5;72.04376983642578 E5 1 43 5;72.08704376220703 B4 1 43 5;71.99507904052734 D4 1 43 5;76.02122497558594 D5 1 43 5;78.0039291381836 C5 1 43 5;80.04866790771484 B4 1 43 5;79.99175262451172 G4 1 43 5;79.98347473144531 E4 1 43 5;79.94960021972656 B5 1 43 5;79.95568084716797 D6 1 43 5;82.02603912353516 A5 1 43 5;83.90697479248047 E5 1 43 5;78.95076751708984 B3 1 43 5;88.08674621582031 B5 1 43 5;90.00609588623047 D6 1 43 5;91.957275390625 G6 1 43 5;94.08618927001953 E6 1 43 5;95.04361724853516 C6 1 43 5;94.03980255126953 G5 1 43 5;93.9718246459961 B4 1 43 5;90.07608795166016 E4 1 43 5;89.93557739257812 D5 1 43 5;87.98503112792969 D4 1 43 5;95.06253051757812 B3 1 43 5;96.05241394042969 F#6 1 43 5;97.90315246582031 A6 1 43 5;99.90802001953125 D7 1 43 5;102.00004577636719 B6 1 43 5;104.04061889648438 F#6 1 43 5;103.93418884277344 D6 1 43 5;103.91459655761719 A5 1 43 5;104.02587890625 B4 1 43 5;107.9529037475586 E6 1 43 5;110.07877349853516 D6 1 43 5;110.97765350341797 A4 1 43 5;112.96131134033203 G5 1 43 5;111.9432373046875 F#5 1 43 5;113.92642974853516 A5 1 43 5;116.0977783203125 E5 1 43 5;119.0953598022461 B4 1 43 5;120.03640747070312 A4 1 43 5;119.98371887207031 F#5 1 43 5;121.09141540527344 G5 1 43 5;122.06851196289062 A5 1 43 5;123.94412231445312 F#5 1 43 5;125.03605651855469 A5 1 43 5;125.99508666992188 D6 1 43 5;97.95223236083984 E4 1 43 5;100.05711364746094 A4 1 43 5;102.06908416748047 E4 1 43 5;103.92152404785156 A3 1 43 5;112.03056335449219 G4 1 43 5;96.03006744384766 E5 1 43 5;95.96329498291016 B5 1 43 5;96.05779266357422 A4 1 43 5;63.93510818481445 E3 1 43 5;71.9473876953125 D3 1 43 5;79.97061157226562 G3 1 43 5;96.053466796875 A3 1 43 5;103.96134185791016 A2 1 43 5;111.99835205078125 G3 1 43 5;123.94083404541016 E4 1 43 5;124.0343246459961 B2 1 43 5;123.94831848144531 B4 1 43 5;123.92639923095703 D5 1 43 5;112.01988220214844 B3 1 43 5;111.97193145751953 B6 1 43 5;29.936725616455078 G5 1 43 5;29.99069595336914 B4 1 43 5;30.087472915649414 E6 1 43 5;47.90873336791992 F#5 1 43 5;55.95949935913086 F#5 1 43 5;56.97690963745117 G5 1 43 5;58.0583610534668 A5 1 43 5;60.02691650390625 F#5 1 43 5;45.900089263916016 D#6 1 43 5;60.02226257324219 E6 1 43 5;60.07268142700195 B4 1 43 5;60.01431655883789 D5 1 43 5;60.08336639404297 B2 1 43 5;59.99385070800781 E4 1 43 5;127.02967071533203 A5 1 43 5;128.06768798828125 A4 1 43 5;127.9036865234375 E5 1 43 5;127.94706726074219 B5 1 43 5;136.0380096435547 E5 1 43 5;136.09706115722656 B4 1 43 5;136.00048828125 D4 1 43 5;141.94964599609375 C5 1 43 5;143.9512176513672 B4 1 43 5;144.06777954101562 G4 1 43 5;143.96336364746094 E4 1 43 5;143.92457580566406 B5 1 43 5;144.04904174804688 D6 1 43 5;142.9839324951172 B3 1 43 5;152.01295471191406 B5 1 43 5;154.0968475341797 D6 1 43 5;153.98306274414062 E4 1 43 5;153.9533233642578 D5 1 43 5;152.0398712158203 D4 1 43 5;159.9540557861328 F#6 1 43 5;168.0856475830078 F#6 1 43 5;168.05125427246094 D6 1 43 5;167.98854064941406 A5 1 43 5;167.92620849609375 B4 1 43 5;173.91958618164062 D#5 1 43 5;183.08474731445312 B4 1 43 5;183.96298217773438 A4 1 43 5;167.98678588867188 A3 1 43 5;175.9013214111328 G4 1 43 5;159.9318084716797 E5 1 43 5;160.01846313476562 B5 1 43 5;160.08932495117188 A4 1 43 5;128.0154571533203 E3 1 43 5;136.01583862304688 D3 1 43 5;143.9026336669922 G3 1 43 5;160.08668518066406 A3 1 43 5;167.9588165283203 A2 1 43 5;175.94692993164062 G3 1 43 5;175.9679718017578 B3 1 43 5;175.9816131591797 B6 1 43 5;158.08041381835938 G5 1 43 5;157.9886932373047 B4 1 43 5;157.9424591064453 E6 1 43 5;176.07879638671875 F#5 1 43 5;184.03199768066406 F#5 1 43 5;184.93992614746094 G5 1 43 5;185.9830322265625 A5 1 43 5;188.050537109375 F#5 1 43 5;173.9647979736328 D#6 1 43 5;188.09678649902344 E6 1 43 5;188.0673828125 B4 1 43 5;188.0418701171875 D5 1 43 5;187.97784423828125 B2 1 43 5;187.90733337402344 E4 1 43 5;128.9351043701172 F#5 1 43 5;130.02330017089844 B5 1 43 5;131.01181030273438 F#5 1 43 5;132.07571411132812 D6 1 43 5;133.09182739257812 F#5 1 43 5;135.0091552734375 B5 1 43 5;133.9224853515625 A5 1 43 5;137.02110290527344 G5 1 43 5;137.94427490234375 F#5 1 43 5;138.97955322265625 D5 1 43 5;139.97805786132812 E5 1 43 5;141.03939819335938 B4 1 43 5;142.91973876953125 A4 1 43 5;144.9410858154297 D5 1 43 5;145.95692443847656 F#5 1 43 5;146.94076538085938 A5 1 43 5;147.9346923828125 B5 1 43 5;150.0327911376953 D6 1 43 5;152.05322265625 E6 1 43 5;154.0045623779297 A5 1 43 5;156.01307678222656 C6 1 43 5;161.99620056152344 A6 1 43 5;163.00672912597656 F#6 1 43 5;164.0435028076172 D6 1 43 5;165.08566284179688 A5 1 43 5;165.9432373046875 G5 1 43 5;166.9290008544922 E5 1 43 5;170.04443359375 F#6 1 43 5;171.07225036621094 E6 1 43 5;172.09193420410156 D6 1 43 5;173.09693908691406 B5 1 43 5;174.08517456054688 G5 1 43 5;177.04563903808594 B4 1 43 5;178.02560424804688 D#5 1 43 5;178.925048828125 F#5 1 43 5;181.03575134277344 D#5 1 43 5;182.0840606689453 F#5 1 43 5;136.06680297851562 B6 1 43 5;137.9354705810547 D7 1 43 5;188 A6 1 43 5'
        mySong = music(song,True,4)
        musicPlaying = True;

        #Run music on second thread
        musicThreadInstance = _thread.start_new_thread(musicThread, ())
        
    def close(self): #Optional, called by main.py when it must exit back to main menu
        global musicPlaying
        musicPlaying = False
    
    def tick(self): #Required, called by main.py in a loop
        start_time = utime.ticks_us()
        self.frame = self.frame + 1
        
        #Demo graphics
        self.display.fill(0)
        self.display.text(str(self.frame),2,2)
        self.display.fill_rect(self.frame % (self.display.width-1),self.frame % self.display.height,10,10,1)
        self.display.stroke_rect((self.frame+64) % (self.display.width-1),(self.frame+64) % self.display.height,10,10,1)
        self.display.stroke_rect(0,0,self.display.width,self.display.height,1)
        
        #Read joystick input and use it to scroll graphics
        joy = self.controller.readJoystick()
        if (joy[2]):
            self.display.scroll(int(joy[0]),int(joy[1]))
            
        #Render display
        self.display.show()
        
        #Wait a fixed amount of time between ticks (independent of time taken to calculate stuff in tick())
        while (utime.ticks_us() - start_time < 40000):
            pass
